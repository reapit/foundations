import{r as h,j as e,aa as A,ai as te,ao as I,ad as x,ap as k,as as B,aw as ne,al as le,ac as E,ae as F,af as D,W as ie,am as oe,ab as M,ax as O,a7 as re,aj as de,an as pe}from"./vendor-_Ftg20Hp.js";import{u as R,d as j}from"./index.esm-DOuwMxsP.js";import{r as g,l as ce,a as q,U as $,o as me,u as ue,g as H,G as V,S as he}from"./index-D0G8dB-d.js";import{c as fe}from"./index-URb_F5BA.js";import{S as be}from"./index-CKZRxNYs.js";import{s as Ie,f as ge}from"./developers-CE6c-PGq.js";import{g as xe,f as Ce,U as je}from"./constants-aos_c5Ih.js";import{u as ve,a as Se}from"./use-permissions-state-ywRtgMZ7.js";import{u as G}from"./use-reapit-update-CuujF-Tn.js";import{f as we}from"./index-C-eCv2z-.js";import{c as ye,a as Ae,o as De}from"./yup-COG2kgBL.js";import"./FileSaver.min-CvPjENXQ.js";const Re=a=>!(!a||/^[\w\-\s£$@%&*()?!%/=+'"~^,‘’.#;:]+$/.test(a)&&/^((?!javascript).)*$/.test(a.toLowerCase()));var Te={appEnv:"development",sentryDsn:"",connectClientId:"76q6dqj28batdlespqc36urn8b",connectOAuthUrl:"https://connect.dev.paas.reapit.cloud",connectUserPoolId:"eu-west-2_kiftR4qFc",platformApiUrl:"https://platform.dev.paas.reapit.cloud",developerPortalUri:"https://developers.dev.paas.reapit.cloud",appMarketUri:"https://marketplace.dev.paas.reapit.cloud"};const Le=async a=>{try{const s=await xe(g,"latest");if(s)return Ce({url:`${je.customers}/?${Ie(a)}`,api:Te.platformApiUrl,method:"GET",headers:s})}catch(s){throw ce(s),s}},Ne=a=>({fixedApiConsumptionCost:s})=>{a({fixedApiConsumptionCost:s==="FREE"?0:void 0})},Pe=(a,s)=>()=>{s&&a()},Ue=(a,s)=>()=>{const n=s(Ne(a));return()=>n.unsubscribe()},Ye=({installIdConsumption:a,installations:s,installationsRefresh:n})=>{var f,m;const{register:c,watch:i}=R(),o=((m=(f=s==null?void 0:s.data)==null?void 0:f.find(b=>b.id===a))==null?void 0:m.fixedApiConsumptionCost)!==0,[,,l,r]=G({reapitConnectBrowserSession:g,action:q[$.updateInstallation],method:"PUT",uriParams:{installationId:a}});return h.useEffect(Pe(n,!!r),[r]),h.useEffect(Ue(l,i),[l]),e.jsx("form",{children:e.jsx(A,{className:te,children:e.jsx(I,{children:e.jsxs(x,{children:[e.jsx(k,{children:"API Consumption Charges"}),e.jsx(B,{...c("fixedApiConsumptionCost"),hasGreyBg:!0,options:[{id:"option-free-false",value:"NOT_FREE",text:"Pays for API consumption",isChecked:o},{id:"option-free-true",value:"FREE",text:"API consumption free",isChecked:!o}]})]})})})})},ke=ye().shape({terminatedReason:Ae().trim().required("Required").min(10,"Must be a minimum of 10 characters").test({name:"hasNoSpecialChars",message:"Special characters are not permitted",test:a=>a?!Re(a):!0})}),Be=({installationId:a,appId:s,onClose:n,installationRefresh:c})=>{var C;const[i,o]=h.useState(!1),{connectSession:l}=ve(g),[,,r]=G({reapitConnectBrowserSession:g,action:q[$.terminateInstallation],uriParams:{installationId:a}}),f=async({terminatedReason:S})=>{o(!0);const p=await r({appId:s,terminatedBy:l==null?void 0:l.loginIdentity.email,terminatedReason:S,terminatesOn:new Date().toISOString()});o(!1),p&&(c(),n())},{handleSubmit:m,formState:{errors:b},register:d,reset:v}=R({resolver:De(ke),defaultValues:{terminatedReason:""}});return e.jsxs(ne,{isOpen:s!==void 0&&a!==void 0,onModalClose:()=>{i||(v(),n())},title:"Confirm Uninstallation",children:[e.jsx(le,{children:"Please provide a reason for terminating this installation"}),e.jsxs("form",{onSubmit:m(f),children:[e.jsx(A,{hasMargin:!0,children:e.jsx(E,{children:e.jsx(x,{label:"Uninstallation Reason",type:"text",...d("terminatedReason"),inputAddOnText:(C=b.terminatedReason)==null?void 0:C.message,intent:"danger"})})}),e.jsx(F,{alignment:"right",children:e.jsx(D,{disabled:i,loading:i,intent:"danger",type:"submit",children:"Uninstall"})})]})]})},z={appIds:"",isInstalled:"ALL"},K=a=>{const{installedDateTo:s,installedDateFrom:n,isInstalled:c,appIds:i,clientId:o,companyName:l,isChargedConsumption:r}=a,f=c==="INSTALLED"?{isInstalled:!0}:c==="UNINSTALLED"?{isInstalled:!0}:{},m=i?{appId:i.split(",").filter(Boolean)}:{},b=o?{clientId:o}:{},d=l?{companyName:l}:{};return me({installedDateTo:s?j(s).format("YYYY-MM-DDTHH:mm:ss"):void 0,installedDateFrom:n?j(n).format("YYYY-MM-DDTHH:mm:ss"):void 0,isChargedConsumption:r,...f,...m,...b,...d})},_=(a,s)=>()=>{const n=s(we(a,500));return()=>n.unsubscribe()},W=(a,s)=>()=>{s&&a(s)},J=()=>{var L,N,P,U;const[a,s]=h.useState(z),{hasReadAccess:n}=Se(),[c,i]=h.useState(1),[o,l]=h.useState(12),[r,f]=h.useState(null),[m,b]=h.useState({appId:void 0,installationId:void 0}),{register:d,watch:v,getValues:C,formState:{errors:S}}=R({mode:"onChange",defaultValues:z});h.useEffect(_(s,v),[]);const[p,X,,T]=ue({reapitConnectBrowserSession:g,action:H[V.getInstallations],queryParams:{...K(a),includeOfficeGroups:!0,pageNumber:c,pageSize:o}});return e.jsxs(ie,{children:[e.jsx(oe,{children:"Installations"}),e.jsx("form",{children:e.jsxs(A,{className:M,children:[e.jsx(E,{children:e.jsx(he,{id:"app-ids-select",label:"Search Apps",errorString:((L=S.appIds)==null?void 0:L.message)??"",defaultList:[],currentValues:((P=(N=C().appIds)==null?void 0:N.split(","))==null?void 0:P.filter(Boolean))??[],reapitConnectBrowserSession:g,valueKey:"id",nameKey:"name",searchKey:"appName",dataListKey:"data",action:H[V.getApps],queryParams:{pageSize:100},noneSelectedLabel:"No apps selected",...d("appIds")})}),e.jsx(I,{children:e.jsx(O,{label:"Company",id:"developer-search-box",...d("companyName"),getResults:t=>ge({company:t,status:"confirmed"}).then(u=>(u==null?void 0:u.data)??[]),getResultLabel:t=>`${t.company} -  ${t.name}`,getResultValue:t=>t.company??"",placeholder:"Search developer organisations"})}),e.jsx(I,{children:e.jsx(O,{label:"Client",id:"client-search-box",...d("clientId"),getResults:t=>Le({name:t}).then(u=>(u==null?void 0:u.data)??[]),getResultLabel:t=>t.name??"",getResultValue:t=>t.agencyCloudId??"",placeholder:"Search customers"})}),e.jsx(I,{children:e.jsx(x,{...d("installedDateFrom"),label:"Installed Date From",type:"date"})}),e.jsx(I,{children:e.jsx(x,{...d("installedDateTo"),label:"Installed Date To",type:"date"})}),e.jsx(I,{children:e.jsxs(x,{children:[e.jsx(k,{children:"Is Charged Consumption"}),e.jsx(B,{...d("isChargedConsumption"),hasGreyBg:!0,options:[{id:"option-consumption-all",value:"",text:"All",isChecked:!0},{id:"option-consumption-true",value:"true",text:"Charged",isChecked:!1},{id:"option-consumption-false",value:"false",text:"Free",isChecked:!1}]})]})})]})}),e.jsx(be,{area:"INSTALLATIONS",data:p,setPageSize:l}),X?e.jsx(re,{}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:M,rows:(U=p==null?void 0:p.data)==null?void 0:U.map(({customerName:t,client:u,customerAddress:Z,created:Q,installedBy:ee,uninstalledBy:w,terminatesOn:Y,appName:ae,id:y,appId:se})=>({cells:[{label:"Customer Name",value:t,icon:"property",cellHasDarkText:!0,narrowTable:{showLabel:!0}},{label:"App Name",value:ae,icon:"insights",cellHasDarkText:!0,narrowTable:{showLabel:!0}},{label:"Reapit Customer Code",value:u,narrowTable:{showLabel:!0}},{label:"Customer Address",value:fe(Z),narrowTable:{showLabel:!0}},{label:"Date Installed",value:j(Q).format("DD-MM-YYYY"),narrowTable:{showLabel:!0}},{label:"Installed By",value:ee,narrowTable:{showLabel:!0}},{label:"Date Uninstalled",value:Y?j(Y).format("DD-MM-YYYY"):"-",narrowTable:{showLabel:!0}},{label:"Uninstalled By",value:w??"-",narrowTable:{showLabel:!0}}],expandableContent:{content:e.jsxs(e.Fragment,{children:[e.jsxs(F,{alignment:"center",children:[e.jsx(D,{intent:"primary",disabled:n,onClick:W(f,y),children:"Togggle API Consumption"}),e.jsx(D,{onClick:()=>b({installationId:y,appId:se}),disabled:w!==null&&w!=="",intent:"danger",children:"Uninstall"})]}),r&&r===y&&e.jsx(Ye,{installIdConsumption:r,installations:p,installationsRefresh:T})]})}}))}),e.jsx(pe,{callback:i,currentPage:c,numberPages:Math.ceil(((p==null?void 0:p.totalCount)??1)/12)})]}),e.jsx(Be,{appId:m.appId,installationId:m.installationId,onClose:()=>b({appId:void 0,installationId:void 0}),installationRefresh:T})]})};export{J as Installations,J as default,K as formatFilters,W as handleInstallIdConsumption,_ as handleSetInstallationsFilters};
