import{r as h,j as e,a7 as T,aa as te,ae as I,z as b,i as k,ag as B,ai as ne,L as le,y as E,k as F,c as D,W as ie,ac as oe,a8 as M,aj as O,B as re,ab as de,ad as ce}from"./vendor-troV5kp-.js";import{u as L,d as j}from"./index.esm-zVN26rm4.js";import{r as C,l as pe,a as $,U as q,o as me,u as ue,g as G,G as H,S as he}from"./index-7tW5-Pg7.js";import{c as fe}from"./index-PuzADKUO.js";import{S as ge}from"./index-1k5r5oX4.js";import{s as Ie,f as Ce}from"./developers-gaNWywzP.js";import{g as be,f as xe,U as je}from"./constants-PNvbKeey.js";import{u as ve,a as Se}from"./use-permissions-state-3iXP9x9E.js";import{u as V}from"./use-reapit-update-Z5Casrho.js";import{f as we}from"./index-tSHtSDOC.js";import{c as ye,a as Te,o as De}from"./yup-pS53ROqe.js";import"./FileSaver.min-JSyqwKbI.js";const Le=a=>!(!a||/^[\w\-\s£$@%&*()?!%/=+'"~^,‘’.#;:]+$/.test(a)&&/^((?!javascript).)*$/.test(a.toLowerCase()));var Re={appEnv:"local",sentryDsn:"",connectClientId:"5g5gmhc2r11df5vqoavvdvef5",connectOAuthUrl:"https://connect.dev.paas.reapit.cloud",connectUserPoolId:"eu-west-2_kiftR4qFc",platformApiUrl:"https://platform.dev.paas.reapit.cloud",developerPortalUri:"https://developers.dev.paas.reapit.cloud",appMarketUri:"https://marketplace.dev.paas.reapit.cloud"};const Ae=async a=>{try{const s=await be(C,"latest");if(s)return xe({url:`${je.customers}/?${Ie(a)}`,api:Re.platformApiUrl,method:"GET",headers:s})}catch(s){throw pe(s),s}},Ne=a=>({fixedApiConsumptionCost:s})=>{a({fixedApiConsumptionCost:s==="FREE"?0:void 0})},Ue=(a,s)=>()=>{s&&a()},Pe=(a,s)=>()=>{const n=s(Ne(a));return()=>n.unsubscribe()},Ye=({installIdConsumption:a,installations:s,installationsRefresh:n})=>{var f,m;const{register:p,watch:i}=L(),o=((m=(f=s==null?void 0:s.data)==null?void 0:f.find(g=>g.id===a))==null?void 0:m.fixedApiConsumptionCost)!==0,[,,l,r]=V({reapitConnectBrowserSession:C,action:$[q.updateInstallation],method:"PUT",uriParams:{installationId:a}});return h.useEffect(Ue(n,!!r),[r]),h.useEffect(Pe(l,i),[l]),e.jsx("form",{children:e.jsx(T,{className:te,children:e.jsx(I,{children:e.jsxs(b,{children:[e.jsx(k,{children:"API Consumption Charges"}),e.jsx(B,{...p("fixedApiConsumptionCost"),hasGreyBg:!0,options:[{id:"option-free-false",value:"NOT_FREE",text:"Pays for API consumption",isChecked:o},{id:"option-free-true",value:"FREE",text:"API consumption free",isChecked:!o}]})]})})})})},ke=ye().shape({terminatedReason:Te().trim().required("Required").min(10,"Must be a minimum of 10 characters").test({name:"hasNoSpecialChars",message:"Special characters are not permitted",test:a=>a?!Le(a):!0})}),Be=({installationId:a,appId:s,onClose:n,installationRefresh:p})=>{var x;const[i,o]=h.useState(!1),{connectSession:l}=ve(C),[,,r]=V({reapitConnectBrowserSession:C,action:$[q.terminateInstallation],uriParams:{installationId:a}}),f=async({terminatedReason:S})=>{o(!0);const c=await r({appId:s,terminatedBy:l==null?void 0:l.loginIdentity.email,terminatedReason:S,terminatesOn:new Date().toISOString()});o(!1),c&&(p(),n())},{handleSubmit:m,formState:{errors:g},register:d,reset:v}=L({resolver:De(ke),defaultValues:{terminatedReason:""}});return e.jsxs(ne,{isOpen:s!==void 0&&a!==void 0,onModalClose:()=>{i||(v(),n())},title:"Confirm Uninstallation",children:[e.jsx(le,{children:"Please provide a reason for terminating this installation"}),e.jsxs("form",{onSubmit:m(f),children:[e.jsx(T,{hasMargin:!0,children:e.jsx(E,{children:e.jsx(b,{label:"Uninstallation Reason",type:"text",...d("terminatedReason"),inputAddOnText:(x=g.terminatedReason)==null?void 0:x.message,intent:"danger"})})}),e.jsx(F,{alignment:"right",children:e.jsx(D,{disabled:i,loading:i,intent:"danger",type:"submit",children:"Uninstall"})})]})]})},K={appIds:"",isInstalled:"ALL"},z=a=>{const{installedDateTo:s,installedDateFrom:n,isInstalled:p,appIds:i,clientId:o,companyName:l,isChargedConsumption:r}=a,f=p==="INSTALLED"?{isInstalled:!0}:p==="UNINSTALLED"?{isInstalled:!0}:{},m=i?{appId:i.split(",").filter(Boolean)}:{},g=o?{clientId:o}:{},d=l?{companyName:l}:{};return me({installedDateTo:s?j(s).format("YYYY-MM-DDTHH:mm:ss"):void 0,installedDateFrom:n?j(n).format("YYYY-MM-DDTHH:mm:ss"):void 0,isChargedConsumption:r,...f,...m,...g,...d})},_=(a,s)=>()=>{const n=s(we(a,500));return()=>n.unsubscribe()},W=(a,s)=>()=>{s&&a(s)},J=()=>{var A,N,U,P;const[a,s]=h.useState(K),{hasReadAccess:n}=Se(),[p,i]=h.useState(1),[o,l]=h.useState(12),[r,f]=h.useState(null),[m,g]=h.useState({appId:void 0,installationId:void 0}),{register:d,watch:v,getValues:x,formState:{errors:S}}=L({mode:"onChange",defaultValues:K});h.useEffect(_(s,v),[]);const[c,X,,R]=ue({reapitConnectBrowserSession:C,action:G[H.getInstallations],queryParams:{...z(a),includeOfficeGroups:!0,pageNumber:p,pageSize:o}});return e.jsxs(ie,{children:[e.jsx(oe,{children:"Installations"}),e.jsx("form",{children:e.jsxs(T,{className:M,children:[e.jsx(E,{children:e.jsx(he,{id:"app-ids-select",label:"Search Apps",errorString:((A=S.appIds)==null?void 0:A.message)??"",defaultList:[],currentValues:((U=(N=x().appIds)==null?void 0:N.split(","))==null?void 0:U.filter(Boolean))??[],reapitConnectBrowserSession:C,valueKey:"id",nameKey:"name",searchKey:"appName",dataListKey:"data",action:G[H.getApps],queryParams:{pageSize:100},noneSelectedLabel:"No apps selected",...d("appIds")})}),e.jsx(I,{children:e.jsx(O,{label:"Company",id:"developer-search-box",...d("companyName"),getResults:t=>Ce({company:t,status:"confirmed"}).then(u=>(u==null?void 0:u.data)??[]),getResultLabel:t=>`${t.company} -  ${t.name}`,getResultValue:t=>t.company??"",placeholder:"Search developer organisations"})}),e.jsx(I,{children:e.jsx(O,{label:"Client",id:"client-search-box",...d("clientId"),getResults:t=>Ae({name:t}).then(u=>(u==null?void 0:u.data)??[]),getResultLabel:t=>t.name??"",getResultValue:t=>t.agencyCloudId??"",placeholder:"Search customers"})}),e.jsx(I,{children:e.jsx(b,{...d("installedDateFrom"),label:"Installed Date From",type:"date"})}),e.jsx(I,{children:e.jsx(b,{...d("installedDateTo"),label:"Installed Date To",type:"date"})}),e.jsx(I,{children:e.jsxs(b,{children:[e.jsx(k,{children:"Is Charged Consumption"}),e.jsx(B,{...d("isChargedConsumption"),hasGreyBg:!0,options:[{id:"option-consumption-all",value:"",text:"All",isChecked:!0},{id:"option-consumption-true",value:"true",text:"Charged",isChecked:!1},{id:"option-consumption-false",value:"false",text:"Free",isChecked:!1}]})]})})]})}),e.jsx(ge,{area:"INSTALLATIONS",data:c,setPageSize:l}),X?e.jsx(re,{}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:M,rows:(P=c==null?void 0:c.data)==null?void 0:P.map(({customerName:t,client:u,customerAddress:Z,created:Q,installedBy:ee,uninstalledBy:w,terminatesOn:Y,appName:ae,id:y,appId:se})=>({cells:[{label:"Customer Name",value:t,icon:"flatInfographic",cellHasDarkText:!0,narrowTable:{showLabel:!0}},{label:"App Name",value:ae,icon:"appInfographic",cellHasDarkText:!0,narrowTable:{showLabel:!0}},{label:"Reapit Customer Code",value:u,narrowTable:{showLabel:!0}},{label:"Customer Address",value:fe(Z),narrowTable:{showLabel:!0}},{label:"Date Installed",value:j(Q).format("DD-MM-YYYY"),narrowTable:{showLabel:!0}},{label:"Installed By",value:ee,narrowTable:{showLabel:!0}},{label:"Date Uninstalled",value:Y?j(Y).format("DD-MM-YYYY"):"-",narrowTable:{showLabel:!0}},{label:"Uninstalled By",value:w??"-",narrowTable:{showLabel:!0}}],expandableContent:{content:e.jsxs(e.Fragment,{children:[e.jsxs(F,{alignment:"center",children:[e.jsx(D,{intent:"primary",disabled:n,onClick:W(f,y),children:"Togggle API Consumption"}),e.jsx(D,{onClick:()=>g({installationId:y,appId:se}),disabled:w!==null&&w!=="",intent:"danger",children:"Uninstall"})]}),r&&r===y&&e.jsx(Ye,{installIdConsumption:r,installations:c,installationsRefresh:R})]})}}))}),e.jsx(ce,{callback:i,currentPage:p,numberPages:Math.ceil(((c==null?void 0:c.totalCount)??1)/12)})]}),e.jsx(Be,{appId:m.appId,installationId:m.installationId,onClose:()=>g({appId:void 0,installationId:void 0}),installationRefresh:R})]})};export{J as Installations,J as default,z as formatFilters,W as handleInstallIdConsumption,_ as handleSetInstallationsFilters};
